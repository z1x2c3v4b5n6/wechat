# 桌面端校园即时通信系统

本项目提供一个客户端-服务器架构的桌面即时通信原型，覆盖校园常见的注册、登录、好友/群聊、离线消息、文件转发等能力。服务器基于 TCP 多线程+SQLite，客户端提供 Tkinter 图形界面。

## 快速开始

### 环境要求
- Python 3.10+（标准库即可，无需额外依赖）
- 操作系统需支持 Tkinter（Linux 桌面/Windows/macOS 默认自带）

### 1. 启动服务器
```bash
python server.py
```
服务器启动后默认监听 `0.0.0.0:9009`，首次运行会自动初始化数据库并创建管理员账号 `admin/admin`。

### 2. 启动客户端
在另一终端运行：
```bash
python client.py
```
若服务器不在本机，可通过环境变量指定：
```bash
CHAT_HOST=服务器IP CHAT_PORT=9009 python client.py
```

### 3. 基本演示流程
1. **注册或直接使用管理员账号登录。**
2. **添加好友**：输入对方用户名后即可互为好友。
3. **创建群聊**：点击“新建群聊”设置名称；其他用户可输入群 ID 通过“加入群聊”指令加入（在好友/群列表刷新后可见）。
4. **聊天**：在联系人或群聊列表选择对象，输入文本或通过“发送文件”选择图片/文件；文件会经服务器中转并自动保存在客户端 `downloads/` 目录。
5. **离线消息**：收件人离线时消息会写入数据库，下一次登录自动推送并标记“[离线]”。
6. **公告广播**：使用管理员账号在命令行发送 `{ "action": "broadcast", "content": "..." }` JSON（可借助 netcat / 自行扩展客户端按钮）。

## 功能概览
- **用户管理**：注册、登录/注销、资料修改、登录日志。
- **好友管理**：添加/删除好友、在线状态推送（上线/离线事件）。
- **群聊管理**：创建、加入、退出群组；成员列表用于群发。
- **消息类型**：文本、文件/图片（Base64 传输，客户端保存到本地并提示）。
- **历史与离线**：服务器持久化所有消息，离线消息在登录时自动派发并标记已送达。
- **服务器工具**：多线程连接处理、管理员公告广播。

## 代码结构
- `server.py`：TCP 服务器入口，处理指令路由、消息转发、在线状态维护、管理员广播。
- `client.py`：Tkinter 客户端，含登录窗、好友/群列表、聊天窗口、文件发送与保存、状态提示。
- `database.py`：SQLite 数据访问层，负责建表、用户/好友/群组/消息/日志 CRUD，以及默认管理员初始化。
- `chat.db`：运行后生成的数据库文件；如需重置可删除后重启服务器。

## 协议说明（概要）
- 客户端与服务器使用 **JSON 行** 作为报文，每条消息末尾带 `\n`。
- 请求字段示例：
  - 登录：`{"action":"login","username":"alice","password":"123"}`
  - 发送消息：`{"action":"send_message","recipient_type":"user","recipient_id":2,"content_type":"text","content":"hi"}`
- 响应/推送：统一含 `action` 与 `status`，新消息事件为 `{"action":"new_message","data":{...}}`。

## 演示与扩展建议
- 可在多台机器运行多个客户端进行群聊与文件转发演示，观察在线状态与离线消息效果。
- 生产化可进一步补充：密码加密、消息加密、读回执、分页历史查询、断线重连、完善的 UI 设计等。
